name: Deploy Webapp

on:
  push:
    branches: [ new-feature-branch ]   # adjust to your main branch
  workflow_dispatch:  # Allow manual triggers

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      id-token: write        # for OIDC
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: webapp/package-lock.json

      - name: Install dependencies
        working-directory: webapp
        run: npm ci --no-audit --no-fund

      - name: Build (standalone)
        working-directory: webapp
        env:
          NEXT_PUBLIC_API_URL: /api     # same-origin via ALB
          NODE_OPTIONS: --max_old_space_size=1024
        run: |
          echo "ğŸ”¨ Building webapp..."
          node -v && npm -v
          # next.config.js has: output: 'standalone'
          npm run build
          
          echo "ğŸ“¦ Packaging standalone output..."
          rm -rf package && mkdir -p package/.next/static
          cp -R .next/standalone/* package/
          cp -R .next/static/* package/.next/static/
          cp .next/BUILD_ID package/.next/BUILD_ID
          if [ -d "public" ]; then
            cp -R public package/public
          fi
          
          echo "ğŸ—œï¸ Creating deployment package..."
          (cd package && zip -qr ../webapp-${{ github.sha }}.zip .)
          
          echo "âœ… Package created: webapp-${{ github.sha }}.zip"
          ls -lh webapp-${{ github.sha }}.zip

      - name: Configure AWS (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::424592696132:role/GitHubActionsRole  # Replace with your role ARN
          aws-region: ap-south-1

      - name: Upload artifact to S3
        run: |
          echo "â˜ï¸ Uploading to S3..."
          aws s3 cp webapp/webapp-${{ github.sha }}.zip s3://influmojo-deployments/releases/
          echo "âœ… Uploaded to S3: s3://influmojo-deployments/releases/webapp-${{ github.sha }}.zip"

      - name: Deploy to EC2 via SSM
        run: |
          echo "ğŸš€ Deploying to EC2..."
          aws ssm send-command \
            --document-name "AWS-RunShellScript" \
            --instance-ids i-0b338206ea637e1b4 \
            --comment "Deploy webapp $GITHUB_SHA" \
            --parameters 'commands=[
              "set -euo pipefail",
              "echo \"ğŸš€ Starting deployment of webapp-$GITHUB_SHA\"",
              "REL=\"$GITHUB_SHA\"",
              "ZIP=\"/tmp/webapp-$GITHUB_SHA.zip\"",
              "echo \"ğŸ“¦ Downloading package from S3...\"",
              "aws s3 cp s3://influmojo-deployments/releases/webapp-$GITHUB_SHA.zip $ZIP",
              "echo \"ğŸ“ Setting up directories...\"",
              "sudo mkdir -p /opt/influmojo/releases/$REL /opt/influmojo/current",
              "echo \"ğŸ“¦ Extracting package...\"",
              "sudo unzip -qo $ZIP -d /opt/influmojo/releases/$REL",
              "echo \"ğŸ”— Creating symlink...\"",
              "sudo ln -sfn /opt/influmojo/releases/$REL /opt/influmojo/current",
              "echo \"ğŸ”„ Restarting webapp with PM2...\"",
              "NODE_BIN=/home/ssm-user/.nvm/versions/node/v20.19.4/bin",
              "PM2=$NODE_BIN/pm2; NODE=$NODE_BIN/node",
              "cd /opt/influmojo/current",
              "sudo -iu ssm-user bash -lc \"\\\"$PM2\\\" describe webapp >/dev/null 2>&1 && NODE_ENV=production PORT=3000 HOST=0.0.0.0 \\\"$PM2\\\" reload webapp --update-env || NODE_ENV=production PORT=3000 HOST=0.0.0.0 \\\"$PM2\\\" start \\\"$NODE\\\" --name webapp -- .next/standalone/server.js\"",
              "sudo -iu ssm-user bash -lc \"\\\"$PM2\\\" save\"",
              "echo \"âœ… Deployment completed!\"",
              "echo \"ğŸŒ Webapp should be live at: http://influmojo-alb-1717302406.ap-south-1.elb.amazonaws.com/\"",
              "sudo -iu ssm-user bash -lc \"\\\"$PM2\\\" status\"",
              "rm -f $ZIP"
            ]' \
            --output text
          
          echo "â³ Waiting for deployment to complete..."
          # Wait for command to complete
          sleep 30
          
          echo "âœ… Deployment triggered successfully!"
          echo "ğŸŒ Check your webapp at: http://influmojo-alb-1717302406.ap-south-1.elb.amazonaws.com/"

      - name: Deployment Summary
        run: |
          echo "ğŸ‰ Deployment completed!"
          echo "ğŸ“¦ Package: webapp-${{ github.sha }}.zip"
          echo "ğŸŒ URL: http://influmojo-alb-1717302406.ap-south-1.elb.amazonaws.com/"
          echo "ğŸ“‹ Commit: ${{ github.sha }}"
          echo "ğŸ”€ Branch: ${{ github.ref_name }}"