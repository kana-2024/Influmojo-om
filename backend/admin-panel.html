<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Influmojo Admin Panel</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #ffffff;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #20536d 0%, #2c7da0 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .nav-tabs {
            display: flex;
            background: #ffffff;
            border-bottom: 1px solid #dee2e6;
        }

        .nav-tab {
            flex: 1;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            background: none;
            font-size: 1.1em;
            font-weight: 500;
        }

        .nav-tab:hover {
            background: #e9ecef;
        }

        .nav-tab.active {
            background: #20536d;
            color: white;
        }

        .tab-content {
            display: none;
            padding: 30px;
        }

        .tab-content.active {
            display: block;
        }

        .auth-section {
            background: #ffffff;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
            text-align: center;
        }

        .auth-section h3 {
            margin-bottom: 20px;
            color: #20536d;
        }

        .auth-input {
            width: 100%;
            max-width: 400px;
            padding: 12px 15px;
            margin: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s ease;
        }

        .auth-input:focus {
            outline: none;
            border-color: #20536d;
        }

        .btn {
            background: #20536d;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s ease;
            margin: 5px;
        }

        .btn:hover {
            background: #1a4a5f;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-success {
            background: #28a745;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-danger {
            background: #dc3545;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 12px;
            text-align: center;
        }

        .stat-card h3 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .stat-card p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .data-table th,
        .data-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .data-table th {
            background: #20536d;
            color: white;
            font-weight: 600;
        }

        .data-table tr:hover {
            background: #ffffff;
        }

        .status-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 500;
        }

        .status-open { background: #ffffff; color: #856404; }
        .status-in_progress { background: #d1ecf1; color: #0c5460; }
        .status-resolved { background: #d4edda; color: #155724; }
        .status-closed { background: #ffffff; color: #721c24; }

        .priority-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 500;
        }

        .priority-low { background: #e9ecef; color: #495057; }
        .priority-medium { background: #ffffff; color: #856404; }
        .priority-high { background: #ffffff; color: #721c24; }
        .priority-urgent { background: #dc3545; color: #ffffff; }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #333;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #20536d;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #ffffff;
            color: #721c24;
            border: 1px solid #ffffff;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .ticket-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn-sm {
            padding: 8px 15px;
            font-size: 0.9em;
        }

        .search-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            align-items: center;
        }

        .search-bar input {
            flex: 1;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
        }

        .search-bar select {
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            min-width: 150px;
        }

        .hidden {
            display: none;
        }

        /* Modal Styles */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1000; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
            padding-top: 60px;
        }

        .modal-content {
            background-color: #ffffff;
            margin: 5% auto; /* 15% from the top and centered */
            padding: 20px;
            border: 1px solid #888;
            width: 90%; /* Could be more or less, depending on screen size */
            max-width: 1000px; /* Max width for larger screens */
            border-radius: 10px;
            position: relative;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }

        .modal-header h2 {
            margin: 0;
            color: #20536d;
        }

        .close-btn {
            font-size: 2.5em;
            font-weight: bold;
            color: #aaa;
            transition: color 0.3s ease;
        }

        .close-btn:hover,
        .close-btn:focus {
            color: #000;
            text-decoration: none;
            cursor: pointer;
        }

        .modal-body {
            display: grid;
            grid-template-columns: 1fr 1fr; /* Two columns for info */
            gap: 20px;
            margin-bottom: 20px;
        }

        .info-section {
            background: #ffffff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
        }

        .info-section h3 {
            margin-bottom: 15px;
            color: #333;
        }

        .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .info-item label {
            font-weight: 500;
            color: #555;
            font-size: 0.9em;
        }

        .info-item span {
            font-weight: 600;
            color: #20536d;
        }

        .participants-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .participant-card {
            background: #e9ecef;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .participant-card h4 {
            margin-bottom: 10px;
            color: #20536d;
        }

        .participant-info p {
            margin-bottom: 5px;
            font-size: 0.95em;
        }

        .participant-info p:last-child {
            margin-bottom: 0;
        }

        .communication-options {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .comm-option {
            background: #ffffff;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .comm-option h4 {
            margin-bottom: 10px;
            color: #333;
        }

        .phone-actions, .email-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .chat-container {
            height: 400px; /* Fixed height for chat */
            border: 1px solid #eee;
            border-radius: 8px;
            background-color: #ffffff;
            padding: 10px;
        }

        .chat-messages {
            height: 350px;
            overflow-y: auto;
            padding-bottom: 10px;
        }

        .chat-message {
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 10px;
            max-width: 70%;
            clear: both;
        }

        .chat-message.sent {
            background-color: #e1f3d8; /* Light green for sent messages */
            margin-left: auto;
            float: right;
        }

        .chat-message.received {
            background-color: #ffffff; /* Light gray for received messages */
            margin-right: auto;
            float: left;
        }

        .chat-message .sender {
            font-weight: bold;
            color: #20536d;
            margin-bottom: 5px;
        }

        .chat-message .timestamp {
            font-size: 0.8em;
            color: #999;
            margin-top: 5px;
        }

        .no-messages, .error {
            text-align: center;
            padding: 20px;
            color: #666;
            font-style: italic;
        }

        .error {
            color: #dc3545;
        }

        .message-content {
            word-wrap: break-word;
            line-height: 1.4;
        }

        .chat-input {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .chat-input textarea {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            resize: none;
            font-size: 1em;
        }

        .chat-input textarea:focus {
            outline: none;
            border-color: #20536d;
        }

        .chat-actions {
            display: flex;
            gap: 10px;
        }

        .ticket-actions-grid {
            display: grid;
            grid-template-columns: 1fr 1fr; /* Two columns for actions */
            gap: 15px;
        }

        .action-group {
            background: #ffffff;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .action-group h4 {
            margin-bottom: 10px;
            color: #333;
        }

        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            margin-bottom: 10px;
        }

        .form-control:focus {
            outline: none;
            border-color: #20536d;
        }

        .full-width {
            grid-column: 1 / -1; /* Span across both columns */
        }

        .modal.show {
            display: block;
        }

        .modal.hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🎫 Influmojo Admin Panel</h1>
            <p>Agent Management & Ticket System</p>
        </div>

        <!-- Authentication Section -->
        <div id="authSection" class="auth-section">
            <h3>🔐 Authentication Required</h3>
            <input type="text" id="jwtToken" class="auth-input" placeholder="Enter JWT Token">
            <button onclick="setAuthToken()" class="btn">Login</button>
            <button onclick="generateTestToken()" class="btn btn-secondary">Generate Test Token</button>
        </div>

        <!-- Navigation Tabs -->
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('agents')">👥 Agents</button>
            <button class="nav-tab" onclick="showTab('tickets')">🎫 Tickets</button>
            <button class="nav-tab" onclick="showTab('stats')">📊 Statistics</button>
        </div>

        <!-- Agents Tab -->
        <div id="agentsTab" class="tab-content active">
            <h2>👥 Agent Management</h2>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <h3 id="totalAgents">-</h3>
                    <p>Total Agents</p>
                </div>
                <div class="stat-card">
                    <h3 id="activeAgents">-</h3>
                    <p>Active Agents</p>
                </div>
                <div class="stat-card">
                    <h3 id="avgTicketsPerAgent">-</h3>
                    <p>Avg Tickets/Agent</p>
                </div>
            </div>

            <button onclick="showCreateAgentForm()" class="btn btn-success">➕ Create New Agent</button>
            
            <div id="createAgentForm" class="hidden">
                <h3>Create New Agent</h3>
                <div class="form-group">
                    <label>Name:</label>
                    <input type="text" id="agentName" placeholder="Agent Name">
                </div>
                <div class="form-group">
                    <label>Email:</label>
                    <input type="email" id="agentEmail" placeholder="agent@example.com">
                </div>
                <div class="form-group">
                    <label>Phone:</label>
                    <input type="tel" id="agentPhone" placeholder="+1234567890">
                </div>
                <div class="form-group">
                    <label>Specialization:</label>
                    <input type="text" id="agentSpecialization" placeholder="e.g., Technical Support, Billing">
                </div>
                <button onclick="createAgent()" class="btn btn-success">Create Agent</button>
                <button onclick="hideCreateAgentForm()" class="btn btn-secondary">Cancel</button>
            </div>

            <table class="data-table">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Phone</th>
                        <th>Specialization</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="agentsTableBody">
                    <tr>
                        <td colspan="6" class="loading">Loading agents...</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Tickets Tab -->
        <div id="ticketsTab" class="tab-content">
            <h2>🎫 Ticket Management</h2>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <h3 id="totalTickets">-</h3>
                    <p>Total Tickets</p>
                </div>
                <div class="stat-card">
                    <h3 id="openTickets">-</h3>
                    <p>Open Tickets</p>
                </div>
                <div class="stat-card">
                    <h3 id="resolvedTickets">-</h3>
                    <p>Resolved Tickets</p>
                </div>
                <div class="stat-card">
                    <h3 id="avgResolutionTime">-</h3>
                    <p>Avg Resolution (hrs)</p>
                </div>
            </div>

            <div class="search-bar">
                <input type="text" id="ticketSearch" placeholder="Search tickets...">
                <select id="statusFilter">
                    <option value="">All Status</option>
                    <option value="open">Open</option>
                    <option value="in_progress">In Progress</option>
                    <option value="resolved">Resolved</option>
                    <option value="closed">Closed</option>
                </select>
                <button onclick="loadTickets()" class="btn">🔍 Search</button>
                <button onclick="createTestTicket()" class="btn btn-success">➕ Create Test Ticket</button>
            </div>

            <table class="data-table">
                <thead>
                    <tr>
                        <th>Ticket ID</th>
                        <th>Order ID</th>
                        <th>Assigned Agent</th>
                        <th>Status</th>
                        <th>Priority</th>
                        <th>Created At</th>
                        <th>Last Updated</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="ticketsTableBody">
                    <tr>
                        <td colspan="8" class="loading">Loading tickets...</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Statistics Tab -->
        <div id="statsTab" class="tab-content">
            <h2>📊 System Statistics</h2>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <h3 id="totalUsers">-</h3>
                    <p>Total Users</p>
                </div>
                <div class="stat-card">
                    <h3 id="totalOrders">-</h3>
                    <p>Total Orders</p>
                </div>
                <div class="stat-card">
                    <h3 id="totalPackages">-</h3>
                    <p>Total Packages</p>
                </div>
                <div class="stat-card">
                    <h3 id="systemHealth">-</h3>
                    <p>System Health</p>
                </div>
            </div>

            <div id="statsDetails">
                <h3>Detailed Statistics</h3>
                <div id="statsContent" class="loading">Loading statistics...</div>
            </div>
        </div>

        <!-- Ticket View Modal -->
        <div id="ticketViewModal" class="modal hidden">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>🎫 Ticket Details</h2>
                    <button onclick="closeTicketModal()" class="close-btn">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="ticket-info-grid">
                        <!-- Ticket Basic Info -->
                        <div class="info-section">
                            <h3>📋 Ticket Information</h3>
                            <div class="info-grid">
                                <div class="info-item">
                                    <label>Ticket ID:</label>
                                    <span id="modalTicketId">-</span>
                                </div>
                                <div class="info-item">
                                    <label>Status:</label>
                                    <span id="modalTicketStatus">-</span>
                                </div>
                                <div class="info-item">
                                    <label>Created:</label>
                                    <span id="modalTicketCreated">-</span>
                                </div>
                                <div class="info-item">
                                    <label>Last Updated:</label>
                                    <span id="modalTicketUpdated">-</span>
                                </div>
                                <div class="info-item">
                                    <label>Assigned Agent:</label>
                                    <span id="modalTicketAgent">-</span>
                                </div>
                                <div class="info-item">
                                    <label>Priority:</label>
                                    <span id="modalTicketPriority">-</span>
                                </div>
                            </div>
                        </div>

                        <!-- Order Details -->
                        <div class="info-section">
                            <h3>📦 Order Details</h3>
                            <div class="info-grid">
                                <div class="info-item">
                                    <label>Order ID:</label>
                                    <span id="modalOrderId">-</span>
                                </div>
                                <div class="info-item">
                                    <label>Package:</label>
                                    <span id="modalPackageTitle">-</span>
                                </div>
                                <div class="info-item">
                                    <label>Total Amount:</label>
                                    <span id="modalOrderAmount">-</span>
                                </div>
                                <div class="info-item">
                                    <label>Quantity:</label>
                                    <span id="modalOrderQuantity">-</span>
                                </div>
                                <div class="info-item">
                                    <label>Order Status:</label>
                                    <span id="modalOrderStatus">-</span>
                                </div>
                            </div>
                        </div>

                        <!-- Brand & Creator Info -->
                        <div class="info-section">
                            <h3>👥 Participants</h3>
                            <div class="participants-grid">
                                <div class="participant-card">
                                    <h4>🏢 Brand</h4>
                                    <div class="participant-info">
                                        <p><strong>Name:</strong> <span id="modalBrandName">-</span></p>
                                        <p><strong>Email:</strong> <span id="modalBrandEmail">-</span></p>
                                        <p><strong>Phone:</strong> <span id="modalBrandPhone">-</span></p>
                                    </div>
                                </div>
                                <div class="participant-card">
                                    <h4>🎨 Creator</h4>
                                    <div class="participant-info">
                                        <p><strong>Name:</strong> <span id="modalCreatorName">-</span></p>
                                        <p><strong>Email:</strong> <span id="modalCreatorEmail">-</span></p>
                                        <p><strong>Phone:</strong> <span id="modalCreatorPhone">-</span></p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Communication Options -->
                        <div class="info-section">
                            <h3>💬 Communication</h3>
                            <div class="communication-options">
                                <div class="comm-option">
                                    <h4>📱 Chat Session</h4>
                                    <p>StreamChat Channel: <span id="modalStreamChannel">-</span></p>
                                    <button onclick="openChatSession()" class="btn btn-success">Open Chat</button>
                                </div>
                                <div class="comm-option">
                                    <h4>📞 Telephony</h4>
                                    <div class="phone-actions">
                                        <button onclick="callBrand()" class="btn btn-secondary">Call Brand</button>
                                        <button onclick="callCreator()" class="btn btn-secondary">Call Creator</button>
                                        <button onclick="scheduleCall()" class="btn btn-secondary">Schedule Call</button>
                                    </div>
                                </div>
                                <div class="comm-option">
                                    <h4>📧 Email</h4>
                                    <div class="email-actions">
                                        <button onclick="emailBrand()" class="btn btn-secondary">Email Brand</button>
                                        <button onclick="emailCreator()" class="btn btn-secondary">Email Creator</button>
                                        <button onclick="sendUpdate()" class="btn btn-secondary">Send Update</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Chat History -->
                        <div class="info-section full-width">
                            <h3>💬 Chat History</h3>
                            <div class="chat-container">
                                <div id="chatMessages" class="chat-messages">
                                    <div class="loading">Loading chat history...</div>
                                </div>
                                <div class="chat-input">
                                    <textarea id="newMessage" placeholder="Type your message..." rows="3"></textarea>
                                    <div class="chat-actions">
                                        <button onclick="sendMessage()" class="btn btn-success">Send Message</button>
                                        <button onclick="attachFile()" class="btn btn-secondary">Attach File</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Ticket Actions -->
                        <div class="info-section full-width">
                            <h3>⚙️ Ticket Actions</h3>
                            <div class="ticket-actions-grid">
                                <div class="action-group">
                                    <h4>Status Management</h4>
                                    <select id="statusUpdate" class="form-control">
                                        <option value="open">Open</option>
                                        <option value="in_progress">In Progress</option>
                                        <option value="resolved">Resolved</option>
                                        <option value="closed">Closed</option>
                                    </select>
                                    <button onclick="updateTicketStatus()" class="btn btn-success">Update Status</button>
                                </div>
                                <div class="action-group">
                                    <h4>Agent Assignment</h4>
                                    <select id="agentReassign" class="form-control">
                                        <option value="">Select Agent</option>
                                    </select>
                                    <button onclick="reassignTicket()" class="btn btn-secondary">Reassign</button>
                                </div>
                                <div class="action-group">
                                    <h4>Priority</h4>
                                    <select id="priorityUpdate" class="form-control">
                                        <option value="low">Low</option>
                                        <option value="medium">Medium</option>
                                        <option value="high">High</option>
                                        <option value="urgent">Urgent</option>
                                    </select>
                                    <button onclick="updatePriority()" class="btn btn-secondary">Update Priority</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:3002/api';
        let authFailureCount = 0;

        // Authentication Functions
        function setAuthToken() {
            const token = document.getElementById('jwtToken').value.trim();
            if (token) {
                localStorage.setItem('jwtToken', token);
                document.getElementById('authSection').style.display = 'none';
                loadInitialData();
            } else {
                showAlert('Please enter a valid JWT token', 'error');
            }
        }

        function getAuthToken() {
            return localStorage.getItem('jwtToken');
        }

        function clearAuthToken() {
            localStorage.removeItem('jwtToken');
            document.getElementById('authSection').style.display = 'block';
        }

        function generateTestToken() {
            showAlert('Please run: node test-auth.js in the backend directory to generate a test token', 'error');
        }

        // Navigation Functions
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Show selected tab
            document.getElementById(tabName + 'Tab').classList.add('active');
            event.target.classList.add('active');

            // Load data for the tab
            switch(tabName) {
                case 'agents':
                    loadAgents();
                    loadAgentStats();
                    break;
                case 'tickets':
                    loadTickets();
                    loadTicketStats();
                    break;
                case 'stats':
                    loadSystemStats();
                    break;
            }
        }

        // API Request Function
        async function makeRequest(endpoint, method = 'GET', data = null) {
            const token = getAuthToken();
            console.log('Making request to:', `${API_BASE_URL}${endpoint}`);
            console.log('Token being used:', token ? token.substring(0, 20) + '...' : 'No token');
            
            const headers = {
                'Content-Type': 'application/json'
            };
            
            if (token) {
                headers['Authorization'] = `Bearer ${token}`;
            }
            
            console.log('Headers:', headers);

            try {
                const response = await fetch(`${API_BASE_URL}${endpoint}`, {
                    method,
                    headers,
                    body: data ? JSON.stringify(data) : null
                });

                console.log('Response status:', response.status);

                if (response.status === 401 || response.status === 403) {
                    console.log(`${method} ${endpoint} failed: ${response.status}`);
                    authFailureCount++;
                    
                    if (authFailureCount >= 3) {
                        console.log('Clearing auth token due to 401/403 response');
                        clearAuthToken();
                        authFailureCount = 0;
                    }
                    return null;
                }

                authFailureCount = 0; // Reset on successful request
                const responseData = await response.json();
                console.log('Response data:', responseData);
                return responseData;

            } catch (error) {
                console.error('API Error:', error);
                showAlert(`API Error: ${error.message}`, 'error');
                return null;
            }
        }

        // Agent Management Functions
        function showCreateAgentForm() {
            document.getElementById('createAgentForm').classList.remove('hidden');
        }

        function hideCreateAgentForm() {
            document.getElementById('createAgentForm').classList.add('hidden');
            // Clear form
            document.getElementById('agentName').value = '';
            document.getElementById('agentEmail').value = '';
            document.getElementById('agentPhone').value = '';
            document.getElementById('agentSpecialization').value = '';
        }

        async function createAgent() {
            const agentData = {
                name: document.getElementById('agentName').value,
                email: document.getElementById('agentEmail').value,
                phone: document.getElementById('agentPhone').value,
                specialization: document.getElementById('agentSpecialization').value
            };

            const response = await makeRequest('/admin/agents', 'POST', agentData);
            
            if (response && response.success) {
                showAlert('Agent created successfully!', 'success');
                hideCreateAgentForm();
                loadAgents();
                loadAgentStats();
            } else {
                showAlert('Failed to create agent', 'error');
            }
        }

        async function loadAgents() {
            const response = await makeRequest('/admin/agents');
            
            if (!response) {
                document.getElementById('agentsTableBody').innerHTML = 
                    '<tr><td colspan="6" class="loading">Authentication failed</td></tr>';
                return;
            }

            const agents = response.data?.agents || [];
            console.log('Agents response:', response);

            if (agents.length === 0) {
                document.getElementById('agentsTableBody').innerHTML = 
                    '<tr><td colspan="6" class="loading">No agents found</td></tr>';
                return;
            }

            const tbody = document.getElementById('agentsTableBody');
            tbody.innerHTML = agents.map(agent => `
                <tr>
                    <td>${agent.name}</td>
                    <td>${agent.email}</td>
                    <td>${agent.phone || 'N/A'}</td>
                    <td>${agent.specialization || 'N/A'}</td>
                    <td><span class="status-badge status-${agent.status || 'active'}">${agent.status || 'Active'}</span></td>
                    <td>
                        <div class="ticket-actions">
                            <button onclick="editAgent(${agent.id})" class="btn btn-sm btn-secondary">Edit</button>
                            <button onclick="deleteAgent(${agent.id})" class="btn btn-sm btn-danger">Delete</button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        async function loadAgentStats() {
            const response = await makeRequest('/admin/agents/stats');
            
            if (response && response.data?.stats) {
                const stats = response.data.stats;
                document.getElementById('totalAgents').textContent = stats.total_agents || 0;
                document.getElementById('activeAgents').textContent = stats.active_agents || 0;
                document.getElementById('avgTicketsPerAgent').textContent = stats.avg_tickets_per_agent || 0;
            } else {
                // Fallback: count from agents list
                const agentsResponse = await makeRequest('/admin/agents');
                if (agentsResponse && agentsResponse.data?.agents) {
                    const agents = agentsResponse.data.agents;
                    const total = agents.length;
                    const active = agents.filter(a => a.status === 'active').length;
                    
                    document.getElementById('totalAgents').textContent = total;
                    document.getElementById('activeAgents').textContent = active;
                    document.getElementById('avgTicketsPerAgent').textContent = '0';
                }
            }
        }

        // Ticket Management Functions
        async function loadTickets() {
            const statusFilter = document.getElementById('statusFilter').value;
            const searchQuery = document.getElementById('ticketSearch').value;
            
            let endpoint = '/crm/tickets';
            if (statusFilter) {
                endpoint += `?status=${statusFilter}`;
            }

            const response = await makeRequest(endpoint);
            
            if (!response) {
                document.getElementById('ticketsTableBody').innerHTML = 
                    '<tr><td colspan="7" class="loading">Authentication failed</td></tr>';
                return;
            }

            const tickets = response.data?.tickets || [];
            console.log('Tickets response:', response);

            // Store tickets in localStorage for modal access
            localStorage.setItem('currentTickets', JSON.stringify(tickets));

            if (tickets.length === 0) {
                document.getElementById('ticketsTableBody').innerHTML = 
                    '<tr><td colspan="7" class="loading">No tickets found</td></tr>';
                return;
            }

            const tbody = document.getElementById('ticketsTableBody');
            tbody.innerHTML = tickets.map(ticket => {
                // Fix date formatting - handle both ISO strings and Date objects
                let createdDate = 'N/A';
                let updatedDate = 'N/A';
                
                try {
                    if (ticket.created_at) {
                        const created = new Date(ticket.created_at);
                        if (!isNaN(created.getTime())) {
                            createdDate = created.toLocaleString();
                        }
                    }
                    
                    if (ticket.updated_at) {
                        const updated = new Date(ticket.updated_at);
                        if (!isNaN(updated.getTime())) {
                            updatedDate = updated.toLocaleString();
                        }
                    }
                } catch (error) {
                    console.error('Error parsing dates:', error);
                }
                
                return `
                <tr>
                    <td>#${ticket.id}</td>
                    <td>#${ticket.order_id}</td>
                    <td>${ticket.agent?.name || 'Unassigned'}</td>
                    <td><span class="status-badge status-${ticket.status}">${ticket.status.replace('_', ' ')}</span></td>
                    <td><span class="priority-badge priority-${ticket.priority || 'medium'}">${ticket.priority || 'medium'}</span></td>
                    <td>${createdDate}</td>
                    <td>${updatedDate}</td>
                    <td>
                        <div class="ticket-actions">
                            <button onclick="viewTicket(${ticket.id})" class="btn btn-sm btn-secondary">View</button>
                            <button onclick="updateTicketStatus(${ticket.id})" class="btn btn-sm btn-success">Update Status</button>
                            <button onclick="reassignTicket(${ticket.id})" class="btn btn-sm btn-secondary">Reassign</button>
                        </div>
                    </td>
                </tr>
            `}).join('');
        }

        async function loadTicketStats() {
            const response = await makeRequest('/crm/tickets');
            
            if (response && response.data?.tickets) {
                const tickets = response.data.tickets;
                const total = tickets.length;
                const open = tickets.filter(t => t.status === 'open').length;
                const resolved = tickets.filter(t => t.status === 'resolved').length;
                
                document.getElementById('totalTickets').textContent = total;
                document.getElementById('openTickets').textContent = open;
                document.getElementById('resolvedTickets').textContent = resolved;
                document.getElementById('avgResolutionTime').textContent = '24'; // Placeholder
            }
        }

        async function createTestTicket() {
            // Create a test ticket using the existing order
            const response = await makeRequest('/crm/tickets', 'POST', {
                order_id: 1, // Use the test order we created
                stream_channel_id: `test-channel-${Date.now()}`
            });
            
            if (response && response.success) {
                showAlert('Test ticket created successfully!', 'success');
                loadTickets();
                loadTicketStats();
            } else {
                showAlert('Failed to create test ticket', 'error');
            }
        }

        // System Statistics Functions
        async function loadSystemStats() {
            try {
                // Load real system statistics
                const [agentsResponse, ticketsResponse, ordersResponse, packagesResponse] = await Promise.all([
                    makeRequest('/admin/agents'),
                    makeRequest('/crm/tickets'),
                    makeRequest('/orders'),
                    makeRequest('/packages')
                ]);

                // Calculate real statistics
                const totalAgents = agentsResponse?.data?.agents?.length || 0;
                const totalTickets = ticketsResponse?.data?.tickets?.length || 0;
                const totalOrders = ordersResponse?.data?.orders?.length || 0;
                const totalPackages = packagesResponse?.data?.packages?.length || 0;

                // Update statistics display
                document.getElementById('totalUsers').textContent = totalAgents;
                document.getElementById('totalOrders').textContent = totalOrders;
                document.getElementById('totalPackages').textContent = totalPackages;
                document.getElementById('systemHealth').textContent = 'Good';
                
                // Calculate user type breakdown
                const agents = agentsResponse?.data?.agents || [];
                const users = ordersResponse?.data?.orders || [];
                
                const brandUsers = new Set(users.map(order => order.brand?.user?.email).filter(Boolean)).size;
                const creatorUsers = new Set(users.map(order => order.creator?.user?.email).filter(Boolean)).size;
                
                document.getElementById('statsContent').innerHTML = `
                    <div class="stats-grid">
                        <div class="stat-card">
                            <h3>${totalAgents}</h3>
                            <p>Admin Agents</p>
                        </div>
                        <div class="stat-card">
                            <h3>${brandUsers}</h3>
                            <p>Brand Users</p>
                        </div>
                        <div class="stat-card">
                            <h3>${creatorUsers}</h3>
                            <p>Creator Users</p>
                        </div>
                        <div class="stat-card">
                            <h3>${totalTickets}</h3>
                            <p>Support Tickets</p>
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('Error loading system stats:', error);
                // Fallback to placeholder values
                document.getElementById('totalUsers').textContent = '0';
                document.getElementById('totalOrders').textContent = '0';
                document.getElementById('totalPackages').textContent = '0';
                document.getElementById('systemHealth').textContent = 'Unknown';
                
                document.getElementById('statsContent').innerHTML = `
                    <div class="stats-grid">
                        <div class="stat-card">
                            <h3>0</h3>
                            <p>Admin Agents</p>
                        </div>
                        <div class="stat-card">
                            <h3>0</h3>
                            <p>Brand Users</p>
                        </div>
                        <div class="stat-card">
                            <h3>0</h3>
                            <p>Creator Users</p>
                        </div>
                        <div class="stat-card">
                            <h3>0</h3>
                            <p>Support Tickets</p>
                        </div>
                    </div>
                `;
            }
        }

        // Utility Functions
        function showAlert(message, type = 'success') {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            
            document.querySelector('.container').insertBefore(alertDiv, document.querySelector('.nav-tabs'));
            
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }

        function loadInitialData() {
            loadAgents();
            loadAgentStats();
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            const token = getAuthToken();
            if (token) {
                document.getElementById('authSection').style.display = 'none';
                loadInitialData();
            }
        });

        // Placeholder functions for future implementation
        function editAgent(id) {
            showAlert('Edit agent functionality coming soon!', 'error');
        }

        function deleteAgent(id) {
            showAlert('Delete agent functionality coming soon!', 'error');
        }

        function viewTicket(id) {
            // Find the ticket data from the current tickets list
            const tickets = JSON.parse(localStorage.getItem('currentTickets') || '[]');
            const ticket = tickets.find(t => t.id == id);
            
            if (ticket) {
                openTicketModal(ticket);
            } else {
                showAlert('Ticket data not found. Please refresh the tickets list.', 'error');
            }
        }

        async function updateTicketStatus(id) {
            const ticketId = id || document.getElementById('modalTicketId').textContent;
            const statusSelect = document.getElementById('statusUpdate');
            const newStatus = statusSelect.value;
            
            try {
                const response = await makeRequest(`/crm/tickets/${ticketId}/status`, 'PUT', {
                    status: newStatus
                });
                
                if (response && response.success) {
                    showAlert(`Ticket status updated to ${newStatus}`, 'success');
                    // Refresh the tickets list
                    loadTickets();
                    // Update the modal status display
                    document.getElementById('modalTicketStatus').textContent = newStatus.replace('_', ' ');
                } else {
                    showAlert('Failed to update ticket status', 'error');
                }
            } catch (error) {
                console.error('Error updating ticket status:', error);
                showAlert('Error updating ticket status', 'error');
            }
        }

        async function reassignTicket(id) {
            const ticketId = id || document.getElementById('modalTicketId').textContent;
            const agentSelect = document.getElementById('agentReassign');
            const newAgentId = agentSelect.value;
            
            if (!newAgentId) {
                showAlert('Please select an agent to reassign to', 'error');
                return;
            }
            
            try {
                const response = await makeRequest(`/crm/tickets/${ticketId}/reassign`, 'PUT', {
                    agent_id: newAgentId
                });
                
                if (response && response.success) {
                    showAlert(`Ticket reassigned to agent ID ${newAgentId}`, 'success');
                    // Refresh the tickets list
                    loadTickets();
                    // Update the modal agent display
                    document.getElementById('modalTicketAgent').textContent = response.data.agent_name || `Agent ${newAgentId}`;
                } else {
                    showAlert('Failed to reassign ticket', 'error');
                }
            } catch (error) {
                console.error('Error reassigning ticket:', error);
                showAlert('Error reassigning ticket', 'error');
            }
        }

        // Modal Functions
        function openTicketModal(ticket) {
            console.log('🔍 Opening ticket modal for ticket:', ticket);
            
            document.getElementById('modalTicketId').textContent = ticket.id;
            document.getElementById('modalTicketStatus').textContent = ticket.status.replace('_', ' ');
            document.getElementById('modalTicketCreated').textContent = new Date(ticket.created_at).toLocaleString();
            document.getElementById('modalTicketUpdated').textContent = new Date(ticket.updated_at).toLocaleString();
            document.getElementById('modalTicketAgent').textContent = ticket.agent?.name || 'Unassigned';
            document.getElementById('modalTicketPriority').textContent = ticket.priority || 'medium';

            document.getElementById('modalOrderId').textContent = ticket.order_id;
            document.getElementById('modalPackageTitle').textContent = ticket.order?.package?.title || 'N/A';
            document.getElementById('modalOrderAmount').textContent = ticket.order?.total_amount || '0';
            document.getElementById('modalOrderQuantity').textContent = ticket.order?.quantity || '0';
            document.getElementById('modalOrderStatus').textContent = ticket.order?.status || 'N/A';

            document.getElementById('modalBrandName').textContent = ticket.order?.brand?.name || 'N/A';
            document.getElementById('modalBrandEmail').textContent = ticket.order?.brand?.user?.email || 'N/A';
            document.getElementById('modalBrandPhone').textContent = ticket.order?.brand?.phone || 'N/A';
            document.getElementById('modalCreatorName').textContent = ticket.order?.creator?.name || 'N/A';
            document.getElementById('modalCreatorEmail').textContent = ticket.order?.creator?.user?.email || 'N/A';
            document.getElementById('modalCreatorPhone').textContent = ticket.order?.creator?.phone || 'N/A';
            document.getElementById('modalStreamChannel').textContent = ticket.stream_channel_id || 'N/A';

            // Load chat history
            loadChatHistory(ticket.id);

            // Load agents for reassignment dropdown
            loadAgentsForReassignment();

            // Set current priority in dropdown
            const prioritySelect = document.getElementById('priorityUpdate');
            if (prioritySelect) {
                prioritySelect.value = ticket.priority || 'medium';
            }

            const modal = document.getElementById('ticketViewModal');
            modal.classList.remove('hidden');
            
            console.log('🔍 Modal visibility check:');
            console.log('- Modal element:', modal);
            console.log('- Modal display style:', modal.style.display);
            console.log('- Modal classes:', modal.className);
            console.log('- Chat container:', document.getElementById('chatMessages'));
            console.log('- Chat container height:', document.getElementById('chatMessages').offsetHeight);
        }

        function closeTicketModal() {
            document.getElementById('ticketViewModal').classList.add('hidden');
            document.getElementById('chatMessages').innerHTML = '<div class="loading">Loading chat history...</div>';
            document.getElementById('newMessage').value = '';
        }

        async function loadChatHistory(ticketId) {
            try {
                const response = await makeRequest(`/crm/tickets/${ticketId}/messages`);
                const chatMessagesDiv = document.getElementById('chatMessages');
                
                console.log('🔍 Chat History Response:', response);
                console.log('🔍 Response structure:', {
                    hasResponse: !!response,
                    hasData: !!response?.data,
                    hasMessages: !!response?.data?.messages,
                    messagesLength: response?.data?.messages?.length,
                    messages: response?.data?.messages
                });
                
                if (response && response.data?.messages) {
                    const messages = response.data.messages;
                    
                    if (messages.length === 0) {
                        chatMessagesDiv.innerHTML = '<div class="no-messages">No messages yet. Start the conversation!</div>';
                        return;
                    }
                    
                    console.log('🔍 Processing messages:', messages);
                    
                    const htmlContent = messages.map(msg => {
                        const isSent = msg.sender === 'admin';
                        const timestamp = new Date(msg.timestamp).toLocaleString();
                        console.log('🔍 Message details:', {
                            sender: msg.sender,
                            sender_name: msg.sender_name,
                            text: msg.text,
                            timestamp: msg.timestamp,
                            isSent: isSent
                        });
                        return `
                            <div class="chat-message ${isSent ? 'sent' : 'received'}">
                                <div class="sender">${isSent ? 'You' : (msg.sender_name || msg.sender)}</div>
                                <div class="message-content">${msg.text || msg.message_text || 'No content'}</div>
                                <div class="timestamp">${timestamp}</div>
                            </div>
                        `;
                    }).join('');
                    
                    console.log('🔍 Generated HTML:', htmlContent);
                    console.log('🔍 Chat container element:', chatMessagesDiv);
                    console.log('🔍 Chat container styles:', {
                        height: chatMessagesDiv.offsetHeight,
                        scrollHeight: chatMessagesDiv.scrollHeight,
                        clientHeight: chatMessagesDiv.clientHeight,
                        display: window.getComputedStyle(chatMessagesDiv).display,
                        visibility: window.getComputedStyle(chatMessagesDiv).visibility,
                        overflow: window.getComputedStyle(chatMessagesDiv).overflow
                    });
                    
                    chatMessagesDiv.innerHTML = htmlContent;
                    
                    // Scroll to bottom
                    chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight;
                } else {
                    console.log('❌ No messages found in response');
                    chatMessagesDiv.innerHTML = '<div class="error">Failed to load messages</div>';
                }
            } catch (error) {
                console.error('Error loading chat history:', error);
                document.getElementById('chatMessages').innerHTML = '<div class="error">Error loading messages</div>';
            }
        }

        async function sendMessage() {
            const ticketId = document.getElementById('modalTicketId').textContent;
            const messageText = document.getElementById('newMessage').value;
            if (!messageText.trim()) return;

            try {
                const response = await makeRequest(`/crm/tickets/${ticketId}/messages`, 'POST', {
                    sender_id: 1, // Assuming admin user ID is 1
                    message_text: messageText,
                    message_type: 'text'
                });

                if (response && response.success) {
                    document.getElementById('newMessage').value = '';
                    loadChatHistory(ticketId);
                    showAlert('Message sent successfully!', 'success');
                } else {
                    showAlert('Failed to send message', 'error');
                }
            } catch (error) {
                console.error('Error sending message:', error);
                showAlert('Error sending message', 'error');
            }
        }

        function attachFile() {
            showAlert('Attach file functionality coming soon!', 'error');
        }

        function openChatSession() {
            const channelId = document.getElementById('modalStreamChannel').textContent;
            if (channelId && channelId !== 'N/A') {
                // For now, open in a new window. Later this will integrate with StreamChat
                window.open(`https://stream-chat.com/channel/${channelId}`, '_blank');
                showAlert('Opening StreamChat session...', 'success');
            } else {
                showAlert('StreamChat channel not available. Please check ticket configuration.', 'error');
            }
        }

        function callBrand() {
            const brandPhone = document.getElementById('modalBrandPhone').textContent;
            if (brandPhone && brandPhone !== 'N/A') {
                // For now, initiate a call using browser's tel: protocol
                // Later this will integrate with Twilio
                window.open(`tel:${brandPhone}`, '_blank');
                showAlert(`Initiating call to brand: ${brandPhone}`, 'success');
            } else {
                showAlert('Brand phone number not available.', 'error');
            }
        }

        function callCreator() {
            const creatorPhone = document.getElementById('modalCreatorPhone').textContent;
            if (creatorPhone && creatorPhone !== 'N/A') {
                // For now, initiate a call using browser's tel: protocol
                // Later this will integrate with Twilio
                window.open(`tel:${creatorPhone}`, '_blank');
                showAlert(`Initiating call to creator: ${creatorPhone}`, 'success');
            } else {
                showAlert('Creator phone number not available.', 'error');
            }
        }

        function scheduleCall() {
            const brandName = document.getElementById('modalBrandName').textContent;
            const creatorName = document.getElementById('modalCreatorName').textContent;
            const ticketId = document.getElementById('modalTicketId').textContent;
            
            // For now, open a calendar scheduling interface
            // Later this will integrate with calendar APIs
            const subject = `Call for Ticket #${ticketId} - ${brandName} & ${creatorName}`;
            const body = `Scheduling a call to discuss ticket #${ticketId} between ${brandName} and ${creatorName}.`;
            
            const calendarUrl = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(subject)}&details=${encodeURIComponent(body)}`;
            window.open(calendarUrl, '_blank');
            
            showAlert('Opening calendar to schedule call...', 'success');
        }

        function emailBrand() {
            const brandEmail = document.getElementById('modalBrandEmail').textContent;
            const brandName = document.getElementById('modalBrandName').textContent;
            const ticketId = document.getElementById('modalTicketId').textContent;
            
            if (brandEmail && brandEmail !== 'N/A') {
                // For now, open default email client
                // Later this will integrate with SendGrid
                const subject = `Ticket #${ticketId} Update`;
                const body = `Dear ${brandName},\n\nThis is regarding your ticket #${ticketId}.\n\nBest regards,\nSupport Team`;
                
                const mailtoUrl = `mailto:${brandEmail}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
                window.open(mailtoUrl, '_blank');
                
                showAlert(`Opening email client for ${brandEmail}`, 'success');
            } else {
                showAlert('Brand email not available.', 'error');
            }
        }

        function emailCreator() {
            const creatorEmail = document.getElementById('modalCreatorEmail').textContent;
            const creatorName = document.getElementById('modalCreatorName').textContent;
            const ticketId = document.getElementById('modalTicketId').textContent;
            
            if (creatorEmail && creatorEmail !== 'N/A') {
                // For now, open default email client
                // Later this will integrate with SendGrid
                const subject = `Ticket #${ticketId} Update`;
                const body = `Dear ${creatorName},\n\nThis is regarding your ticket #${ticketId}.\n\nBest regards,\nSupport Team`;
                
                const mailtoUrl = `mailto:${creatorEmail}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
                window.open(mailtoUrl, '_blank');
                
                showAlert(`Opening email client for ${creatorEmail}`, 'success');
            } else {
                showAlert('Creator email not available.', 'error');
            }
        }

        function sendUpdate() {
            const ticketId = document.getElementById('modalTicketId').textContent;
            const brandEmail = document.getElementById('modalBrandEmail').textContent;
            const creatorEmail = document.getElementById('modalCreatorEmail').textContent;
            
            // For now, show a form to compose update
            // Later this will integrate with SendGrid to send to both parties
            const updateText = prompt('Enter update message to send to both brand and creator:');
            if (updateText) {
                showAlert(`Update sent to brand and creator for ticket #${ticketId}`, 'success');
                // Add the update as a system message in chat
                addSystemMessage(ticketId, updateText);
            }
        }

        async function updatePriority() {
            const ticketId = document.getElementById('modalTicketId').textContent;
            const prioritySelect = document.getElementById('priorityUpdate');
            const newPriority = prioritySelect.value;
            
            try {
                const response = await makeRequest(`/crm/tickets/${ticketId}/priority`, 'PUT', {
                    priority: newPriority
                });
                
                if (response && response.success) {
                    showAlert(`Priority updated to ${newPriority}`, 'success');
                } else {
                    showAlert('Failed to update priority', 'error');
                }
            } catch (error) {
                console.error('Error updating priority:', error);
                showAlert('Error updating priority', 'error');
            }
        }

        async function addSystemMessage(ticketId, messageText) {
            try {
                const response = await makeRequest(`/crm/tickets/${ticketId}/messages`, 'POST', {
                    sender_id: 1, // System user ID
                    message_text: `📢 **System Update:** ${messageText}`,
                    message_type: 'system'
                });

                if (response && response.success) {
                    loadChatHistory(ticketId);
                }
            } catch (error) {
                console.error('Error adding system message:', error);
            }
        }

        async function loadAgentsForReassignment() {
            try {
                const response = await makeRequest('/admin/agents');
                const agentSelect = document.getElementById('agentReassign');
                
                if (response && response.data?.agents) {
                    // Clear existing options
                    agentSelect.innerHTML = '<option value="">Select Agent</option>';
                    
                    // Add agent options
                    response.data.agents.forEach(agent => {
                        const option = document.createElement('option');
                        option.value = agent.id;
                        option.textContent = `${agent.name} (${agent.email})`;
                        agentSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading agents for reassignment:', error);
            }
        }
    </script>
</body>
</html> 