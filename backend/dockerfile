# syntax=docker/dockerfile:1

# ---- deps ----
    FROM node:20-alpine AS deps
    WORKDIR /app
    COPY package*.json ./
    RUN npm ci --no-audit --no-fund --only=production
    
    # ---- runtime ----
    FROM node:20-alpine AS runner
    WORKDIR /app
    ENV NODE_ENV=production
    
    # Copy dependencies
    COPY --from=deps /app/node_modules ./node_modules
    # Copy application code
    COPY . .
    
    # Run as non-root
    RUN addgroup -g 1001 -S nodejs && adduser -S nodejs -u 1001 -G nodejs
    USER 1001
    
    # Port/env for ECS/ALB
    EXPOSE 5000
    ENV PORT=5000
    
    # Health check
    HEALTHCHECK --interval=30s --timeout=5s --retries=5 CMD wget -qO- http://127.0.0.1:5000/health >/dev/null 2>&1 || exit 1
    
    # Start application
    CMD ["npm", "start"]